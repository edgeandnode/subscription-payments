version: '3'
services:
  ipfs:
    image: ipfs/kubo:latest
    ports: ['5001:5001']
    volumes: ['./data/ipfs:/data/ipfs']

  postgres:
    image: postgres
    ports: ['5432:5432']
    volumes: [./data/postgres:/var/lib/postgresql/data]
    command: ['postgres', '-cshared_preload_libraries=pg_stat_statements']
    environment:
      POSTGRES_INITDB_ARGS: '--encoding UTF8 --locale=C'
      POSTGRES_DB: graph-node
      POSTGRES_USER: graph-node
      POSTGRES_PASSWORD: let-me-in

  chain:
    build:
      dockerfile: Dockerfile.chain
    ports: ['8545:8545']

  graph-node:
    depends_on: [ipfs, postgres, chain]
    image: graphprotocol/graph-node
    ports: ['8000:8000', '8001:8001', '8020:8020', '8030:8030', '8040:8040']
    environment:
      GRAPH_LOG: info
      ipfs: 'http://ipfs:5001'
      ethereum: 'mainnet:http://chain:8545'
      postgres_db: graph-node
      postgres_host: postgres
      postgres_user: graph-node
      postgres_pass: let-me-in
