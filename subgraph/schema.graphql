type Init @entity(immutable: true) {
  id: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  token: Bytes! # address
}

type User @entity(immutable: true) {
  id: Bytes!
  subscribeEvents: [Subscribe!]! @derivedFrom(field: "user") # can't have a User with a subscribe
  unsubscribeEvents: [Unsubscribe!] @derivedFrom(field: "user")
  extendEvents: [Unsubscribe!] @derivedFrom(field: "user")
  activeSubscriptions: [ActiveSubscription!] @derivedFrom(field: "user")
  authorizedSigners: [AuthorizedSigner!] @derivedFrom(field: "user")
  # a total count of all events of all types. useful for pagination
  eventCount: Int!
  events: [UserSubscriptionsEvent!] @derivedFrom(field: "user")
}

type Subscribe @entity(immutable: true) {
  id: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  user: User!
  start: BigInt! # uint64
  end: BigInt! # uint64
  rate: BigInt! # uint128
}

type Unsubscribe @entity(immutable: true) {
  id: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  user: User!
}

type Extend @entity(immutable: true) {
  id: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  user: User!
  end: BigInt! # uint64
}

type ActiveSubscription @entity {
  id: Bytes!
  user: User!
  start: BigInt! # uint64
  end: BigInt! # uint64
  rate: BigInt! # uint128
}

type AuthorizedSigner @entity {
  id: Bytes! #keccak256 hex string of user:signer
  user: User!
  signer: Bytes! #address
}

"""
Enum of available User Subscription Event types based off the action the user performed
"""
enum UserSubscriptionsEventType {
  # The user created a net-new Subscription
  CREATED
  # The user canceled their active Subscription
  CANCELED
  # The user renewed (extended the ending timestamp) of their active Subscription
  RENEW
  # The user upgraded (set the rate to a higher value -> more queries available) of their active Subscription
  UPGRADE
  # The user downgraded (set the rate to a lower value -> less queries available) of their active Subscription
  DOWNGRADE
}

"""
Generic interface that maps user events in the Subscriptions contract.

Some example events:
- User creates a net-new subscription -> UserSubscriptionCreatedEvent
- User cancels their active subscription -> UserSubscriptionCanceledEvent
- User renews their active subscription -> UserSubscriptionRenewalEvent
- User upgrades their active subscription -> UserSubscriptionUpgradeEvent
- User downgrades their active subscription -> UserSubscriptionDowngradeEvent
"""
interface UserSubscriptionsEvent {
  # keccak256 hex string of user:{event type}:txHash
  id: Bytes!
  user: User!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  txHash: Bytes!
  eventType: UserSubscriptionsEventType!
}

"""
User created a net-new active Subscription
"""
type UserSubscriptionCreatedEvent implements UserSubscriptionsEvent
  @entity(immutable: true) {
  # keccak256 hex string of user:created:timestamp
  id: Bytes!
  user: User!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  txHash: Bytes!
  # will always be UserSubscriptionsEventType.CREATED
  eventType: UserSubscriptionsEventType!
  # the user's _current_ active subscription
  currentSubscription: ActiveSubscription!
}

"""
User canceled their active subscription
"""
type UserSubscriptionCanceledEvent implements UserSubscriptionsEvent
  @entity(immutable: true) {
  # keccak256 hex string of user:canceled:timestamp
  id: Bytes!
  user: User!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  txHash: Bytes!
  # will always be UserSubscriptionsEventType.CANCELED
  eventType: UserSubscriptionsEventType!
  # the amount of unlocked tokens transferred back to the user as a result of cancelling the ActiveSubscription
  tokensReturned: BigInt!
}

"""
User renewed their active Subscription.

Renewing means that the user extended the end timestamp of their active Subscription to a later timestamp.
"""
type UserSubscriptionRenewalEvent implements UserSubscriptionsEvent
  @entity(immutable: true) {
  # keccak256 hex string of user:renew:timestamp
  id: Bytes!
  user: User!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  txHash: Bytes!
  # will always be UserSubscriptionsEventType.RENEW
  eventType: UserSubscriptionsEventType!
  # the user's _current_ active subscription
  currentSubscription: ActiveSubscription!
}

"""
User upgraded their active Subscription.

Upgrading means that the user increased the `rate` on their active Subscription, granting them more query volume.
"""
type UserSubscriptionUpgradeEvent implements UserSubscriptionsEvent
  @entity(immutable: true) {
  # keccak256 hex string of user:upgrade:timestamp
  id: Bytes!
  user: User!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  txHash: Bytes!
  # will always be UserSubscriptionsEventType.UPGRADE
  eventType: UserSubscriptionsEventType!
  # the ActiveSubscription.start value before the user upgraded their subscription
  previousSubscriptionStart: BigInt! # uint64
  # the ActiveSubscription.end value before the user upgraded their subscription
  previousSubscriptionEnd: BigInt! # uint64
  # the ActiveSubscription.rate value before the user upgraded their subscription
  previousSubscriptionRate: BigInt! # uint128
  # the user's _current_ active subscription
  currentSubscription: ActiveSubscription!
}

"""
User downgraded their active Subscription.

Downgrading means that the user decreased the `rate` on their active Subscription, granting them less query volume.
"""
type UserSubscriptionDowngradeEvent implements UserSubscriptionsEvent
  @entity(immutable: true) {
  # keccak256 hex string of user:downgrade:timestamp
  id: Bytes!
  user: User!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  txHash: Bytes!
  # will always be UserSubscriptionsEventType.DOWNGRADE
  eventType: UserSubscriptionsEventType!
  # the ActiveSubscription.start value before the user downgraded their subscription
  previousSubscriptionStart: BigInt! # uint64
  # the ActiveSubscription.end value before the user downgraded their subscription
  previousSubscriptionEnd: BigInt! # uint64
  # the ActiveSubscription.rate value before the user downgraded their subscription
  previousSubscriptionRate: BigInt! # uint128
  # the user's _current_ active subscription
  currentSubscription: ActiveSubscription!
}
